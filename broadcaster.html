<!DOCTYPE html>
<html>
<head>
    <title>Audio Broadcaster</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.1/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.1/addons/p5.sound.min.js"></script>
    <style>
        body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; background: #111; color: #fff; text-align: center; margin: 0; }
        #status { font-size: 1.2em; padding: 20px; }
        i { color: #888; }
    </style>
</head>
<body>
    <div id="status">Click to start broadcasting...</div>

    <script>
        const statusDiv = document.getElementById('status');
        
        // --- WebSocket Connection ---
        // IMPORTANT: Replace 'YOUR_COMPUTER_IP' with your computer's actual local IP address.
        const socket = new WebSocket('ws://10.45.24.6:8080');

        socket.onopen = () => {
            console.log('Connected to relay server.');
            statusDiv.innerHTML = 'Connected. <br/>Click to start broadcasting...';
        };
        socket.onerror = (error) => {
            console.error('WebSocket Error:', error);
            statusDiv.textContent = 'Error connecting to server. Make sure the server is running and the IP address is correct.';
        };
        socket.onclose = () => {
            console.log('Disconnected from relay server.');
            statusDiv.textContent = 'Disconnected from server.';
        };

        // --- P5.js and Speech Recognition ---
        let mic, fft, audioStarted = false;

        function setup() {
            noCanvas(); // We don't need to draw anything on this page
            mic = new p5.AudioIn();
            fft = new p5.FFT();
            fft.setInput(mic);
        }

        function mousePressed() {
            if (!audioStarted) {
                userStartAudio().then(() => {
                    mic.start();
                    startRecognition();
                    audioStarted = true;
                    statusDiv.textContent = 'Listening...';
                });
            }
        }
        
        function startRecognition() {
            window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!window.SpeechRecognition) {
                statusDiv.textContent = 'Speech recognition not supported on this device/browser.';
                return;
            }

            const recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;

            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
                
                // Analyze audio
                let volume = mic.getLevel();
                let bassEnergy = fft.getEnergy('bass');

                // Prepare data to send
                const data = {
                    text: finalTranscript + interimTranscript,
                    volume: volume,
                    bassEnergy: bassEnergy
                };

                // Send data through WebSocket if connected
                if (socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify(data));
                }
                
                // Update status on the broadcaster page itself
                statusDiv.innerHTML = `<b>Live Text:</b> ${finalTranscript}<i>${interimTranscript}</i><br/><b>Volume:</b> ${volume.toFixed(3)}`;
            };

            recognition.onerror = (event) => {
                console.error('Speech Recognition Error:', event.error);
                statusDiv.textContent = `Speech Recognition Error: ${event.error}`;
            };
            
            recognition.onend = () => {
                // The recognition service can sometimes stop; restart it.
                if (audioStarted) {
                    recognition.start();
                }
            };

            recognition.start();
        }
    </script>
</body>
</html>
